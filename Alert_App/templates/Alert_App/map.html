{% extends "Alert_App/AlertAppBase.html" %}

{%  block title %}Map{% endblock%}

{% block content %}
	<p>Building Map</p>
	{% load static %}
	<img src="{%  static "Alert_App/images/school_map_example.jpg" %}"
	alt="Example of floor plan" style="width:500px;height:500px" id="map" ><br>
	
	{% if user.is_superuser  %}
		<input type="hidden" name="markers" id="data_store" value="" />
		<!--"Markers" hidden element stores marker information in this format:
		<marker_number,x_position,y_position>                              -->
		
		<button type="button" onClick="allowEdits()" id="edit_button">Edit Registered Device Locations</button>
		<p align="center">
			<canvas id="Canvas" height="600" width="600" style="display:none" align="right"></canvas>
		</p>
		<script>
			function cancelEdit(){
				//resets page to initial elements and layout
				var map = document.getElementById("map");
				map.style.display = ""; //revert to original display
				
				var edit_button = document.getElementById("edit_button");
				edit_button.style.display = "";
				
				var canvas = document.getElementById("Canvas");
				canvas.style.display = "none";  //revert to original display
				
				var tmp = document.getElementById("cancel_button");
				tmp.style.display = "none";
				tmp.parentNode.removeChild(tmp)
			}
			function allowEdits(){
				//displays canvas for adding new devices
				var map = document.getElementById("map");
				map.style.display = "none";
				
				var edit_button = document.getElementById("edit_button");
				edit_button.style.display = "none";

				var canvas = document.getElementById("Canvas");
				canvas.style.display = "block";
				
				var data_store = document.getElementById("data_store");
				
				//creates a cancel button 
				var btn = document.createElement("BUTTON");
				btn.setAttribute("id", "cancel_button");
				btn.onclick = cancelEdit;
				var text_str = document.createTextNode("Cancel?");
				btn.appendChild(text_str);
				document.body.appendChild(btn);
				
				// begin making markers 
				var context = canvas.getContext("2d")
				var mapSprite = new Image();
				mapSprite.src = map.src;
				
				var Marker = function () {
					this.Sprite = new Image();
					this.Sprite.src = "http://www.clker.com/cliparts/w/O/e/P/x/i/map-marker-hi.png"
					this.Width = 12;
					this.Height = 20;
					this.XPos = 0;
					this.YPos = 0;
				}

				// Array of markers
				var Markers = new Array();

				// When the user clicks their mouse on our canvas run this code
				var mouseClicked = function (mouse) {
					// Get corrent mouse coords
					var rect = canvas.getBoundingClientRect();
					var mouseXPos = (mouse.x - rect.left);
					var mouseYPos = (mouse.y - rect.top);

					// Move the marker when placed to a better location
					var marker = new Marker();
					marker.XPos = mouseXPos - (marker.Width / 2);
					marker.YPos = mouseYPos - marker.Height;

					// Push our new marker to our Markers array
					Markers.push(marker);
				}

				// Add mouse click event listener to canvas
				canvas.addEventListener("mousedown", mouseClicked, false);

				// Run this once so we setup text rendering
				var firstLoad = function () {
					context.font = "15px Georgia";
					context.textAlign = "center";
				}

				firstLoad();

				// This will be called 60 times a second, look at the code at the bottom `setInterval`
				var main = function () {
					// Update our canvas
					draw();
				};

				var draw = function () {
					// Clear Canvas
					context.fillStyle = "#000";
					context.fillRect(0, 0, canvas.width, canvas.height);

					// Draw map
					// Sprite, X location, Y location, Image width, Image height
					// You can leave the image height and width off, if you do it will draw the image at default size
					context.drawImage(mapSprite, 0, 0,canvas.width,canvas.height);
					
					var data_builder = "";
					// Draw markers
					for (var i = 0; i < Markers.length; i++) {
						
						var tempMarker = Markers[i];
						// Draw marker
						context.drawImage(tempMarker.Sprite, tempMarker.XPos, tempMarker.YPos, tempMarker.Width, tempMarker.Height);
						data_builder += "<"+ (i+1).toString() + ","+(tempMarker.XPos).toString()+ ","+tempMarker.YPos.toString() +">";
						data_store.value = data_builder;
						// Calculate position text
						var markerText = "Device: " + (i +1); //+ " Position (X:" + tempMarker.XPos + ", Y:" + tempMarker.YPos + ")";
						
						// Draw a simple box so you can see the position
						var textMeasurements = context.measureText(markerText);
						context.fillStyle = "#666";
						context.globalAlpha = 0.7;
						context.fillRect(tempMarker.XPos - (textMeasurements.width / 2), tempMarker.YPos - 15, textMeasurements.width, 20);
						context.globalAlpha = 1;

						// Draw position above
						context.fillStyle = "#F83106";
						context.fillText(markerText, tempMarker.XPos, tempMarker.YPos);
					}
				};

				setInterval(main, (1000 / 60)); // Refresh 60 times a second
			} 
		</script>
	{% endif %}
	<button onclick="go_back()">Go Back</button>
	
{% endblock%}